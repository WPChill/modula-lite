wp.Modula=void 0===wp.Modula?{}:wp.Modula,function(e,t){var i=wp.media.view.Toolbar.Select.extend({clickSelect:function(){var e=this.controller,t=e.state(),i=t.get("selection");e.close(),t.trigger("insert",i).reset()}}),o=wp.media.view.AttachmentsBrowser.extend({createToolbar:function(){wp.media.view.AttachmentsBrowser.prototype.createToolbar.call(this),this.toolbar.set("modula-error",new t.upload.errorview({controller:this.controller,priority:-80}))}}),a=wp.media.view.MediaFrame.Select.extend({className:"media-frame modula-media-modal",createStates:function(){var e=this.options;e.library.type="image",this.options.states||this.states.add([new t.upload.library({library:wp.media.query(e.library),multiple:e.multiple,title:e.title,priority:20})])},createSelectToolbar:function(e,i){(i=i||this.options.button||{}).controller=this,e.view=new t.upload.toolbar(i)},browseContent:function(e){var i=this.state();e.view=new t.upload.attachmentsbrowser({controller:this,collection:i.get("library"),selection:i.get("selection"),model:i,sortable:i.get("sortable"),search:i.get("searchable"),filters:i.get("filterable"),date:i.get("date"),display:i.has("display")?i.get("display"):i.get("displaySettings"),dragInfo:i.get("dragInfo"),idealColumnWidth:i.get("idealColumnWidth"),suggestedWidth:i.get("suggestedWidth"),suggestedHeight:i.get("suggestedHeight"),AttachmentView:i.get("AttachmentView")})}}),r=wp.media.model.Selection.extend({add:function(e,t){var i,o;return this.multiple||this.remove(this.models),this.length>=20?(e=[],wp.media.frames.modula.trigger("modula:show-error",{message:modulaHelper.strings.limitExceeded})):(i=20-this.length,Array.isArray(e)&&e.length>1&&(o=_.difference(_.pluck(e,"cid"),_.pluck(this.models,"cid"))).length>i&&(e=(e=_.filter(e,(function(e){return _.contains(o,e.cid)}))).slice(0,i),wp.media.frames.modula.trigger("modula:show-error",{message:modulaHelper.strings.limitExceeded}))),wp.media.model.Attachments.prototype.add.call(this,e,t)},single:function(e){var t=this._single;return e&&(this._single=e),this._single&&!this.get(this._single.cid)&&delete this._single,this._single=this._single||this.last(),this._single!==t&&(t&&(t.trigger("selection:unsingle",t,this),this.get(t.cid)||this.trigger("selection:unsingle",t,this)),this._single&&this._single.trigger("selection:single",this._single,this)),this.length<20&&wp.media.frames.modula.trigger("modula:hide-error",{message:modulaHelper.strings.limitExceeded}),this._single}}),l=wp.media.controller.Library.extend({initialize:function(){var e,t=this.get("selection");this.get("library")||this.set("library",wp.media.query()),t||((e=t)||(e=this.get("library").props.toJSON(),e=_.omit(e,"orderby","query")),this.set("selection",new wp.media.model.Selection(null,{multiple:this.get("multiple"),props:e}))),this.resetDisplays()}}),s=wp.media.View.extend({tagName:"div",className:"modula-error-container hide",errorTimeout:!1,delay:400,message:"",initialize:function(){this.controller.on("modula:show-error",this.show,this),this.controller.on("modula:hide-error",this.hide,this),this.render()},show:function(e){void 0!==e.message&&(this.message=e.message),""!=this.message&&(this.render(),this.$el.removeClass("hide"))},hide:function(){this.$el.addClass("hide")},render:function(){var e='<div class="modula-error"><span>'+this.message+"</span></div>";this.$el.html(e)}}),n=Backbone.Model.extend({uploaderOptions:{container:e("#modula-uploader-container"),browser:e("#modula-uploader-browser"),dropzone:e("#modula-uploader-container")},dropzone:e("#modula-dropzone-container"),progressBar:e(".modula-progress-bar"),containerUploader:e(".modula-upload-actions"),errorContainer:e(".modula-error-container"),galleryCotainer:e("#modula-uploader-container .modula-uploader-inline-content"),modula_files_count:0,limitExceeded:!1,initialize:function(){var i,o,a=this;(i=new wp.Uploader(a.uploaderOptions)).uploader.bind("FilesAdded",e.proxy(a.filesadded,a)),i.uploader.bind("UploadProgress",e.proxy(a.fileuploading,a)),i.uploader.bind("FileUploaded",e.proxy(a.fileupload,a)),i.uploader.bind("UploadComplete",e.proxy(a.filesuploaded,a)),i.uploader.bind("Error",(function(e,t){a.errorContainer.html('<div class="error fade"><p>'+t.file.name+": "+t.message+"</p></div>"),e.refresh()})),(o=i.dropzone).on("dropzone:enter",a.show),o.on("dropzone:leave",a.hide),a.galleryCotainer.on("click",".modula-delete-image",(function(t){t.preventDefault(),e(this).parents(".modula-single-image").remove()})),wp.media.frames.modula=new t.upload.frame({frame:"select",reset:!1,title:wp.media.view.l10n.addToGalleryTitle,button:{text:wp.media.view.l10n.addToGallery},multiple:"add"}),wp.media.frames.modula.on("open",(function(){var e=wp.media.frames.modula.state().get("selection");e.reset(),wp.Modula.Items.each((function(t){var i=wp.media.attachment(t.get("id"));e.add(i?[i]:[])})),e.single(e.last())})),wp.media.frames.modula.on("close",(function(){wp.media.frames.modula.trigger("modula:hide-error",{message:modulaHelper.strings.limitExceeded})})),wp.media.frames.modula.on("insert",(function(e){wp.media.frames.modula.state();var i=wp.Modula.Items;for(t.Items=new t.items.collection,e.each((function(e){var t=e.toJSON(),o=i.get(t.id);o?(wp.Modula.Items.addItem(o),i.remove(o)):a.generateSingleImage(t)}),this);model=i.first();)model.delete()})),e("#modula-wp-gallery").click((function(t){t.preventDefault(),setUserSetting("libraryContent","browse");var i=e("body .media-modal");i.length>0&&i.find("#menu-item-browse").click(),wp.media.frames.modula.open()}))},filesadded:function(t,i){var o=this;o.errorContainer.html(""),o.modula_files_count=i.length,e(".modula-upload-numbers .modula-current",o.containerUploader).text("1"),e(".modula-upload-numbers .modula-total",o.containerUploader).text(o.modula_files_count),o.containerUploader.addClass("show-progress")},fileuploading:function(t,i){var o=this;e(".modula-upload-numbers .modula-current",o.containerUploader).text(o.modula_files_count-t.total.queued+1),e(".modula-progress-bar-inner",o.progressBar).css({width:t.total.percent+"%"})},fileupload:function(e,t,i){var o=JSON.parse(i.response);this.generateSingleImage(o.data)},filesuploaded:function(){var e=this;setTimeout((function(){e.containerUploader.removeClass("show-progress")}),1e3)},show:function(){var t=e("#modula-dropzone-container").show();_.defer((function(){t.css({opacity:1})}))},hide:function(){var t=e("#modula-dropzone-container").css({opacity:0});wp.media.transition(t).done((function(){"0"===t.css("opacity")&&t.hide()})),_.delay((function(){"0"===t.css("opacity")&&t.is(":visible")&&t.hide()}),500)},generateSingleImage:function(e){var i={halign:"center",valign:"middle",link:"",target:"",togglelightbox:""};void 0!==e.sizes?(i.full=e.sizes.full.url,void 0!==e.sizes.large?i.thumbnail=e.sizes.large.url:i.thumbnail=i.full):(i.full=e.url,i.thumbnail=i.full),i.id=e.id,i.alt=e.alt,i.orientation=e.orientation,i.title=e.title,i.description=e.caption,new t.items.model(i)}});t.upload={toolbar:i,attachmentsbrowser:o,frame:a,selection:r,library:l,errorview:s,uploadHandler:n}}(jQuery,wp.Modula);