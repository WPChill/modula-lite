wp.Modula=void 0===wp.Modula?{}:wp.Modula,function(e,t){var i=Backbone.Model.extend({defaults:{item:!1},initialize:function(e){var i=new t.modal.view({model:this,childViews:e.childViews}),a=new wp.media.view.Modal({controller:{trigger:function(){}}});this.set("wpMediaView",a),this.set("modulaModal",i),this.isApiConfigured=!1},open:function(e){var t=this.get("wpMediaView"),i=this.get("modulaModal");this.set("item",e),i.render(),t.content(i),t.open()}}),a=Backbone.View.extend({tagName:"div",className:"edit-attachment-frame mode-select hide-menu hide-router modula-edit-popup",template:wp.template("modula-image-editor"),events:{"click .edit-media-header .left":"loadPreviousItem","click .edit-media-header .right":"loadNextItem","keyup input":"updateItem","keyup textarea":"updateItem","change input":"updateItem","change textarea":"updateItem","blur textarea":"updateItem","change select":"updateItem","click .actions a.modula-gallery-meta-submit":"saveItem","click .actions a.modula-gallery-meta-submit-close":"saveItemAndClose","keyup input#link-search":"searchLinks","click div.query-results li":"insertLink","click #modula-ai-report-generate-button":"generateReport","click #modula-alt-button-apply":"applyReport","click #modula-caption-button-apply":"applyReport","click #modula-title-button-apply":"applyReport"},initialize:function(e){this.on("loading",this.loading,this),this.on("loaded",this.loaded,this),this.listenTo(this.model,"change:item",this.changeItem),this.childViews=e.childViews,this.is_loading=!1,this.search_timer="",this.item=!1,this.on("ai:report:loading",this.onReportLoading,this),this.on("ai:report:success",this.onReportSuccess,this),this.on("ai:report:error",this.onReportError,this)},changeItem:function(){this.item=this.model.get("item")},render:function(){return this.item||(this.item=this.model.get("item")),this.checkApiStatus(),this.attachment_index=t.Items.indexOf(this.item),this.item&&(this.$el.html(this.template(this.item.toJSON())),this.childViews.length>0&&this.childViews.forEach((function(e){var t=new e({model:this.model});this.$el.find("div.modula-addons").append(t.render().el)}),this)),0==this.attachment_index&&this.$el.find("button.left").addClass("disabled"),this.attachment_index==t.Items.length-1&&this.$el.find("button.right").addClass("disabled"),"external-url"!=t.Settings.get("lightbox")?this.$el.find(".setting.modula-link").addClass("modula-hide"):this.$el.find(".setting.modula-link").removeClass("modula-hide"),this},renderError:function(e){var t={};return t.error=e,new wp.media.view.ModulaGalleryError({model:t}).render().el},loading:function(){this.is_loading=!0,this.$el.find(".spinner").css("visibility","visible")},loaded:function(e){this.is_loading=!1,this.$el.find(".spinner").css("visibility","hidden"),void 0!==e&&this.$el.find("div.media-toolbar").after(this.renderError(e))},loadPreviousItem:function(){var e;this.attachment_index--,e=t.Items.at(this.attachment_index),this.model.set("item",e),this.render()},loadNextItem:function(){var e;this.attachment_index++,e=t.Items.at(this.attachment_index),this.model.set("item",e),this.render()},updateItem:function(e){""!=e.target.name&&("checkbox"==e.target.type?value=e.target.checked?e.target.value:0:value=e.target.value,this.item.set(e.target.name,value))},saveItem:function(e){var t=this;this.model.get("item");e.preventDefault(),this.trigger("loading"),this.item.get("view").render();var i=this.$el.find(".saved");i.fadeIn(),wp.Modula.Save.saveImages((function(){t.trigger("loaded loaded:success"),i.fadeOut()}))},saveItemAndClose:function(e){var t=this;e.preventDefault(),this.trigger("loading"),clearInterval(wp.Modula.Save.updateInterval),wp.Modula.Save.saveImages((function(){t.model.get("wpMediaView").close()}))},searchLinks:function(e){},insertLink:function(e){},generateReport:async function(e){if(e.preventDefault(),this.isApiConfigured){var t=e.target.dataset.action||"generate";if(void 0!==wp.apiFetch){this.trigger("ai:report:loading");try{var i=await wp.apiFetch({path:"/modula-ai-image-descriptor/v1/generate-alt-text/",method:"POST",data:{id:"single",attachment_id:this.item.get("id"),action:t}});this.trigger("ai:report:success",i)}catch(e){this.trigger("ai:report:error",e)}}}else window.location.href=modulaHelper.settings_url},onReportLoading:function(){var e=this.$el.find("#modula-ai-report-generate-button");e.addClass("loading").prop("disabled",!0),e.text(modulaHelper.strings.generating_alt_text),this.item.set("report",{})},onReportSuccess:function(e){var t=this.$el.find("#modula-ai-report-generate-button");t.removeClass("loading").prop("disabled",!1),t.text(modulaHelper.strings.alt_text_generated),setTimeout((()=>{t.text(modulaHelper.strings.refresh_report)}),2500),this.item.set("report",e),this.item.set("alt",e.altText),this.$el.find('input[name="alt"]').val(e.altText),this.item.set("description",e.caption),this.$el.find('textarea[name="description"]').val(e.caption),this.item.set("title",e.title),this.$el.find('input[name="title"]').val(e.title)},onReportError:function(e){this.$el.find("#modula-ai-report-generate-button").removeClass("loading").prop("disabled",!1),console.error("AI Report generation failed:",e),this.item.set("report",{})},checkApiStatus:async function(){const e=this;try{const t=await wp.apiFetch({path:"/modula-ai-image-descriptor/v1/ai-settings",method:"GET"}),i=this.$el.find("#modula-ai-report-generate-button");t?.readonly?.valid_key??!1?(e.isApiConfigured=!0,i.removeClass("configure-api")):(i.text(modulaHelper.strings.configure_api_key||"Configure API Key"),i.addClass("configure-api"),e.isApiConfigured=!1)}catch(t){console.error("API check failed:",t);const i=e.$el.find("#modula-ai-report-generate-button");i.text(modulaHelper.strings.configure_api_key||"Configure API Key"),i.addClass("configure-api"),e.isApiConfigured=!1}}});t.modal={model:i,view:a}}(jQuery,wp.Modula);