const{__:__}=wp.i18n;wp.Modula=void 0===wp.Modula?{}:wp.Modula;class ModulaGalleryUpload{postID=0;progressClass=!1;deleteFiles=!0;zipUploadHandler=null;constructor(){const e=this;e.add_actions(),e.postObject=document.getElementById("post_ID"),e.postObject&&(e.postID=e.postObject.value)}add_actions(){const e=this,a=document.getElementById("modula-uploader-folder-browser"),t=document.getElementById("modula_create_gallery");a&&(a.addEventListener("click",(function(a){return a.preventDefault(),window.send_to_editor=window.send_to_browse_file_url,tb_show("<h1>"+modulaGalleryUpload.browseFolder+"</h1>","media-upload.php?post_id="+e.postID+"&amp;type=modula_file_browser&amp;from=wpdlm01&amp;TB_iframe=true&amp;width=800&amp;height=600"),!1})),e.readIframeData(),e.setUploaders(),e.initializeUploaders());const o=document.querySelector(".modula_file_browser");o&&o.addEventListener("change",(function(a){a.target.matches('input[type="checkbox"]')&&e.updateSendButtonState(o,t)}))}fileBrowser(){const e=this;document.body.addEventListener("click",(function(a){a.target&&a.target.matches(".modula_file_browser a")&&(a.preventDefault(),e.addFolderClick(a.target))})),e.foldersFilesValidation()}addFolderClick(e){const a=this,t=jQuery(e),o=t.closest("li"),l=o.find('input[type="checkbox"]').is(":checked");if(o.is(".folder_open"))o.find("ul").remove(),o.removeClass("folder_open");else{t.after('<ul class="load_tree loading"></ul>');var s={action:"modula_list_folders",path:t.attr("data-path"),postID:a.postID,security:modulaGalleryUpload.security,"input-checked":l};jQuery.post(modulaGalleryUpload.ajaxUrl,s,(function(e){o.addClass("folder_open"),e?o.find(".load_tree").html(e):o.find(".load_tree").html(modulaGalleryUpload.noSubFolders),o.find(".load_tree").removeClass("load_tree loading")}))}return!1}foldersFilesValidation(){const e=this;document.getElementById("modula_create_gallery").addEventListener("click",(async function(a){a.preventDefault(),e.deleteFiles=document.getElementById("delete_files").checked,e.progressClass.changeText(modulaGalleryUpload.startFolderValidation);const t=document.querySelectorAll('.modula_file_browser input[type="checkbox"]:checked'),o=Array.from(t).map((e=>e.value)),l=await e.checkPaths(JSON.stringify(o));if(!l.success)return void e.progressClass.changeText(l.data);e.progressClass.changeText(__("Found ","modula-best-grid-gallery")+l.data.length+__(" folders. Starting files validation...","modula-best-grid-gallery"));const s=await e.filesValidation(JSON.stringify(l.data));s.success?(e.progressClass.changeText(__("Found ","modula-best-grid-gallery")+s.data.length+__(" valid files. Starting importing the files...","modula-best-grid-gallery")),e.importFiles(s.data)):e.progressClass.changeText(s.data)}))}async checkPaths(e){if(0===e.length)return{success:!1,data:modulaGalleryUpload.noFoldersSelected};const a=this;a.postID||(a.postID=document.getElementById("post_ID").value);const t={action:"modula_check_paths",paths:e,security:modulaGalleryUpload.security,post_ID:a.postID},o=await a.ajaxCall(t);return await JSON.parse(o)}async filesValidation(e){const a={action:"modula_check_files",paths:e,security:modulaGalleryUpload.security},t=await this.ajaxCall(a);return await JSON.parse(t)}async ajaxCall(e){return new Promise(((a,t)=>{var o=new XMLHttpRequest,l=new URLSearchParams;if(e)for(let a in e)e.hasOwnProperty(a)&&l.append(a,e[a]);o.open("POST",modulaGalleryUpload.ajaxUrl,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){4===o.readyState&&(200===o.status?a(o.response):t(o.response))},o.onerror=function(){console.error("Request failed")},o.send(l.toString())}))}async importFiles(e,a=!1){const t=this;0===t.postID&&(t.postID=document.getElementById("post_ID").value);let o=[];a?(t.progressClass.hideBar(),t.progressClass.initNoModal(e),t.progressClass.noModalShowBar()):t.progressClass.update(.3,e.length);for(let l=0;l<e.length;l++){a?(t.progressClass.changeText(""),t.progressClass.noModalProgress(l+1)):t.progressClass.changeText(__("Importing file ","modula-best-grid-gallery")+(l+1)+__(" of ","modula-best-grid-gallery")+e.length);const s={action:"modula_import_file",file:e[l],post_ID:t.postID,security:modulaGalleryUpload.security,delete_files:t.deleteFiles},r=await t.ajaxCall(s),d=await JSON.parse(r);d.success?(a||t.progressClass.update(l+1,e.length),o.push(d.data)):t.progressClass.changeText(d.data)}o.length>0?(t.progressClass.changeText(__("Imported ","modula-best-grid-gallery")+o.length+__(" files.","modula-best-grid-gallery")),a?(t.progressClass.changeText(""),t.progressClass.hideBar(),t.progressClass.noModalHideBar(),t.updateGallery(o,!0)):setTimeout((function(){t.progressClass.hideBar(),a||t.progressClass.changeText(modulaGalleryUpload.updatingGallery),t.updateGallery(o)}),2e3)):t.progressClass.hideBar()}async updateGallery(e,a=!1){const t=this;t.postID=document.getElementById("post_ID").value;const o={action:"modula_add_images_ids",ids:e,galleryID:t.postID,security:modulaGalleryUpload.security},l=await t.ajaxCall(o),s=await JSON.parse(l);if(s.success){a||t.progressClass.changeText(modulaGalleryUpload.galleryUpdated);const e={action:"modula_gallery_updated",postID:t.postID,images:s.data,security:modulaGalleryUpload.security};t.sendDataToParent(e)}}sendDataToParent(e){window.parent.postMessage(e,"*")}readIframeData(){const e=this;window.addEventListener("message",(function(a){if(a.data){if(void 0===a.data.action||"undefined"===a.data.security)return;if(modulaGalleryUpload.security!==a.data.security)return;if("modula_gallery_updated"===a.data.action){tb_remove(),e.addFilesToGallery(a.data.images);const t=document.querySelector("#wpbody-content > .wrap"),o=__("Import process completed.","modula-best-grid-gallery");e.addNotice(t,o,"success")}}}))}addFilesToGallery(e){const a=this,t=Object.values(e);for(let e=0;e<t.length;e++){const o=a.generateSingleImage(t[e]);"start"===document.querySelector('input[name="modula-settings[upload_position]"]:checked').value&&(wp.Modula.Items.add(o,{at:0}),wp.Modula.Items.trigger("newItemAdded",o)),wp.Modula.GalleryView.render()}}generateSingleImage(e){var a={halign:"center",valign:"middle",link:"",target:"",togglelightbox:"",hideTitle:""};return void 0!==e.sizes?(a.full=e.sizes.full.url,void 0!==e.sizes.large?a.thumbnail=e.sizes.large.url:a.thumbnail=a.full):(a.full=e.url,a.thumbnail=a.full),a.id=e.id,a.alt=e.alt,a.orientation=e.orientation,a.title=e.title,a.description=e.caption,new wp.Modula.items.model(a)}addNotice(e,a,t){const o=document.createElement("div");o.className="notice notice-"+t+" is-dismissible",o.innerHTML="<p>"+a+"</p>",e.insertBefore(o,e.firstChild)}setUploaders(){const e=this;e.zipUploadHandler=Backbone.Model.extend({uploaderOptions:{container:jQuery("#modula-uploader-container"),browser:jQuery("#modula-upload-zip-browser"),params:{type:"modula-gallery",action:"modula_upload_zip",short:!0}},progressBar:jQuery(".modula-progress-bar"),containerUploader:jQuery(".modula-uploading-info"),errorContainer:jQuery(".modula-error-container"),galleryCotainer:jQuery("#modula-uploader-container .modula-uploader-inline-content"),modula_files_count:0,limitExceeded:!1,initialize:function(){var e,a=this;(e=new wp.Uploader(a.uploaderOptions)).uploader.bind("FilesAdded",jQuery.proxy(a.filesadded,a)),e.uploader.bind("UploadProgress",jQuery.proxy(a.fileuploading,a)),e.uploader.bind("FileUploaded",jQuery.proxy(a.fileupload,a)),e.uploader.bind("UploadComplete",jQuery.proxy(a.filesuploaded,a)),e.uploader.bind("Error",(function(e,t){let o=t.message;if(void 0!==t.response){o=JSON.parse(t.response).message}a.errorContainer.html('<div class="error fade"><p>'+t.file.name+": "+o+"</p></div>"),e.refresh()}))},filesadded:function(a,t){e.progressClass=new ModulaProgressClass("modula-uploader-container"),e.progressClass.display()},fileuploading:function(e,a){},fileupload:async function(a,t,o){e.progressClass.changeText(__("File uploaded, extracting zip...","modula-best-grid-gallery"));var l={action:"modula_unzip_file",fileID:o.response,security:modulaGalleryUpload.security};const s=await e.ajaxCall(l),r=await JSON.parse(s);if(r.success){e.progressClass.changeText(__(".zip extracted, checking files...","modula-best-grid-gallery"));const a=await e.checkPaths(JSON.stringify(r.data));if(!a.success)return void e.progressClass.changeText(a.data);e.progressClass.changeText(__("Found ","modula-best-grid-gallery")+a.data.length+__(" folders. Starting files validation...","modula-best-grid-gallery"));const t=await e.filesValidation(JSON.stringify(a.data));if(!t.success)return void e.progressClass.changeText(t.data);e.progressClass.changeText(__("Found ","modula-best-grid-gallery")+t.data.length+__(" valid files. Starting importing the files...","modula-best-grid-gallery")),e.importFiles(t.data,!0)}},filesuploaded:function(){}})}initializeUploaders(){new this.zipUploadHandler}updateSendButtonState(e,a){const t=e.querySelectorAll('input[type="checkbox"]:checked');a.classList.toggle("disabled",0===t.length)}}class ModulaProgressClass{wrapper=null;progressBar=0;progressText="";progress=0;total=0;noModal=!1;noModalContainer=null;noModalFilesCount=0;noModalProgressBar=0;constructor(e,a=!1){const t=this;t.noModal=a,t.noModal||(t.wrapper=document.getElementById(e),t.progressBar=document.createElement("div"),t.progressBar.className="modula-progress-bar",t.progressText=document.createElement("div"),t.progressText.className="modula-progress-text")}display(){const e=this;e.wrapper.appendChild(e.progressText),e.wrapper.appendChild(e.progressBar)}update(e,a){const t=this;t.progress=e,t.total=a,t.progressBar.style.width=e/a*100+"%"}changeText(e){this.progressText.innerHTML=e}hideBar(){this.progressBar.style.display="none"}initNoModal(e){const a=this;a.noModalContainer=jQuery(".modula-uploading-info"),a.noModalProgressBar=jQuery(".modula-progress-bar"),a.noModalFilesCount=e.length}noModalShowBar(){const e=this;jQuery(".modula-upload-numbers .modula-current",e.noModalContainer).text("1"),jQuery(".modula-upload-numbers .modula-total",e.noModalContainer).text(e.noModalFilesCount),e.noModalContainer.addClass("show-progress")}noModalHideBar(){const e=this;setTimeout((function(){e.noModalContainer.removeClass("show-progress")}),1e3)}noModalProgress(e){const a=this;jQuery(".modula-upload-numbers .modula-current",a.noModalContainer).text(e),jQuery(".modula-progress-bar-inner",a.noModalProgressBar).css({width:Math.round(100*e/a.noModalFilesCount)+"%"})}}document.addEventListener("DOMContentLoaded",(function(){window.send_to_browse_file_url=function(e){tb_remove(),window.send_to_editor=window.send_to_editor_default},new ModulaGalleryUpload}));