const{__:__}=wp.i18n;wp.Modula=void 0===wp.Modula?{}:wp.Modula;class ModulaGalleryUpload{postID=0;progressMode=!1;deleteFiles=!0;zipUploadHandler=null;constructor(){const e=this;e.add_actions(),e.postObject=document.getElementById("post_ID"),e.postObject&&(e.postID=e.postObject.value)}add_actions(){const e=this,a=document.getElementById("modula-uploader-folder-browser"),t=document.getElementById("modula_create_gallery");a&&(a.addEventListener("click",(function(a){return a.preventDefault(),window.send_to_editor=window.send_to_browse_file_url,tb_show("<h1>"+modulaGalleryUpload.browseFolder+"</h1>","media-upload.php?post_id="+e.postID+"&amp;type=modula_file_browser&amp;from=wpdlm01&amp;TB_iframe=true&amp;width=800&amp;height=600"),!1})),e.readIframeData(),e.setUploaders(),e.initializeUploaders());const o=document.querySelector(".modula_file_browser");o&&o.addEventListener("change",(function(a){a.target.matches('input[type="checkbox"]')&&e.updateSendButtonState(o,t)}));const l=document.querySelector('div[notice-target="modula_uploaded_files"]');l&&l.addEventListener("click",(function(a){const t={action:"modula_dismiss_upload_error_notice",post_ID:e.postID,security:modulaGalleryUpload.security};e.ajaxCall(t)}))}fileBrowser(){const e=this;document.body.addEventListener("click",(function(a){a.target&&a.target.matches(".modula_file_browser a")&&(a.preventDefault(),e.addFolderClick(a.target))})),e.foldersFilesValidation()}addFolderClick(e){const a=this,t=jQuery(e),o=t.closest("li"),l=o.find('input[type="checkbox"]').is(":checked");if(o.is(".folder_open"))o.find("ul").remove(),o.removeClass("folder_open");else{t.after('<ul class="load_tree loading"></ul>');var d={action:"modula_list_folders",path:t.attr("data-path"),postID:a.postID,security:modulaGalleryUpload.security,"input-checked":l};jQuery.post(modulaGalleryUpload.ajaxUrl,d,(function(e){o.addClass("folder_open"),e?o.find(".load_tree").html(e):o.find(".load_tree").html(modulaGalleryUpload.noSubFolders),o.find(".load_tree").removeClass("load_tree loading")}))}return!1}foldersFilesValidation(){const e=this;document.getElementById("modula_create_gallery").addEventListener("click",(async function(a){a.preventDefault(),a.target.classList.add("disabled"),e.deleteFiles=document.getElementById("delete_files").checked,e.progressMode.changeText(modulaGalleryUpload.startFolderValidation);const t=document.querySelectorAll('.modula_file_browser input[type="checkbox"]:checked'),o=Array.from(t).map((e=>e.value)),l=await e.checkPaths(JSON.stringify(o));if(!l.success)return void e.progressMode.changeText(l.data);e.progressMode.changeText(__("Found ","modula-best-grid-gallery")+l.data.length+__(" folders. Starting files validation...","modula-best-grid-gallery"));const d=await e.filesValidation(JSON.stringify(l.data));d.success?(e.progressMode.changeText(__("Found ","modula-best-grid-gallery")+d.data.length+__(" valid files. Starting importing the files...","modula-best-grid-gallery")),e.importFiles(d.data,!0)):e.progressMode.changeText(d.data)}))}async checkPaths(e){if(0===e.length)return{success:!1,data:modulaGalleryUpload.noFoldersSelected};const a=this;a.postID||(a.postID=document.getElementById("post_ID").value);const t={action:"modula_check_paths",paths:e,security:modulaGalleryUpload.security,post_ID:a.postID},o=await a.ajaxCall(t);return await JSON.parse(o)}async filesValidation(e){const a={action:"modula_check_files",paths:e,security:modulaGalleryUpload.security},t=await this.ajaxCall(a);return await JSON.parse(t)}async ajaxCall(e){return new Promise(((a,t)=>{var o=new XMLHttpRequest,l=new URLSearchParams;if(e)for(let a in e)e.hasOwnProperty(a)&&l.append(a,e[a]);o.open("POST",modulaGalleryUpload.ajaxUrl,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){4===o.readyState&&(200===o.status?a(o.response):t(o.response))},o.onerror=function(){console.error("Request failed")},o.send(l.toString())}))}async importFiles(e,a=!1){const t=this;0===t.postID&&(t.postID=document.getElementById("post_ID").value);let o=[];a?t.progressMode.update(.3,e.length):(t.progressMode.initNoModal(e),t.progressMode.noModalShowBar());for(let l=0;l<e.length;l++){a?t.progressMode.changeText(__("Importing file ","modula-best-grid-gallery")+(l+1)+__(" of ","modula-best-grid-gallery")+e.length):(t.progressMode.changeText(""),t.progressMode.noModalProgress(l+1));const d={action:"modula_import_file",file:e[l],post_ID:t.postID,security:modulaGalleryUpload.security,delete_files:t.deleteFiles},r=await t.ajaxCall(d),s=await JSON.parse(r);s.success?(a&&t.progressMode.update(l+1,e.length),o.push(s.data)):a||t.progressMode.changeText(s.data)}o.length>0?(t.progressMode.changeText(__("Imported ","modula-best-grid-gallery")+o.length+__(" files.","modula-best-grid-gallery")),a?setTimeout((function(){t.progressMode.hideBar(),a&&t.progressMode.changeText(modulaGalleryUpload.updatingGallery),t.updateGallery(o)}),2e3):(t.progressMode.changeText(""),t.progressMode.noModalHideBar(),t.updateGallery(o,!1))):a&&t.progressMode.hideBar()}async updateGallery(e,a=!0){const t=this;t.postID=document.getElementById("post_ID").value;const o={action:"modula_add_images_ids",ids:e,galleryID:t.postID,security:modulaGalleryUpload.security},l=await t.ajaxCall(o),d=await JSON.parse(l);if(d.success){a&&t.progressMode.changeText(modulaGalleryUpload.galleryUpdated);const e={action:"modula_gallery_updated",postID:t.postID,images:d.data,security:modulaGalleryUpload.security};t.sendDataToParent(e)}}sendDataToParent(e){window.parent.postMessage(e,"*")}readIframeData(){const e=this;window.addEventListener("message",(function(a){if(a.data){if(void 0===a.data.action||"undefined"===a.data.security)return;if(modulaGalleryUpload.security!==a.data.security)return;if("modula_gallery_updated"===a.data.action){tb_remove(),e.addFilesToGallery(a.data.images);const t=document.querySelector("#wpbody-content > .wrap"),o=__("Import process completed.","modula-best-grid-gallery");e.addNotice(t,o,"success")}}}))}addFilesToGallery(e){const a=this,t=Object.values(e);for(let e=0;e<t.length;e++){const o=a.generateSingleImage(t[e]);"start"===document.querySelector('input[name="modula-settings[upload_position]"]:checked').value&&(wp.Modula.Items.add(o,{at:0}),wp.Modula.Items.trigger("newItemAdded",o)),wp.Modula.GalleryView.render()}}generateSingleImage(e){var a={halign:"center",valign:"middle",link:"",target:"",togglelightbox:"",hideTitle:""};return void 0!==e.sizes?(a.full=e.sizes.full.url,void 0!==e.sizes.large?a.thumbnail=e.sizes.large.url:a.thumbnail=a.full):(a.full=e.url,a.thumbnail=a.full),a.id=e.id,a.alt=e.alt,a.orientation=e.orientation,a.title=e.title,a.description=e.caption,new wp.Modula.items.model(a)}addNotice(e,a,t){const o=document.createElement("div");o.className="notice notice-"+t+" is-dismissible",o.innerHTML="<p>"+a+"</p>",e.insertBefore(o,e.firstChild)}setUploaders(){const e=this;e.progressMode=new ModulaProgress("modula-uploader-container",!1),e.progressMode.display(),e.zipUploadHandler=Backbone.Model.extend({uploaderOptions:{container:jQuery("#modula-uploader-container"),browser:jQuery("#modula-upload-zip-browser"),params:{type:"modula-gallery",action:"modula_upload_zip",short:!0}},progressBar:jQuery(".modula-progress-bar"),containerUploader:jQuery(".modula-uploading-info"),errorContainer:jQuery(".modula-error-container"),galleryCotainer:jQuery("#modula-uploader-container .modula-uploader-inline-content"),modula_files_count:0,limitExceeded:!1,initialize:function(){var e,a=this;(e=new wp.Uploader(a.uploaderOptions)).uploader.bind("FilesAdded",jQuery.proxy(a.filesadded,a)),e.uploader.bind("UploadProgress",jQuery.proxy(a.fileuploading,a)),e.uploader.bind("FileUploaded",jQuery.proxy(a.fileupload,a)),e.uploader.bind("UploadComplete",jQuery.proxy(a.filesuploaded,a)),e.uploader.bind("Error",(function(e,t){let o=t.message;if(void 0!==t.response){o=JSON.parse(t.response).message}a.errorContainer.html('<div class="error fade"><p>'+t.file.name+": "+o+"</p></div>"),e.refresh()}))},filesadded:function(e,a){},fileuploading:function(e,a){},fileupload:async function(a,t,o){e.progressMode.changeText(__("File uploaded, extracting zip...","modula-best-grid-gallery"));var l={action:"modula_unzip_file",fileID:o.response,security:modulaGalleryUpload.security};const d=await e.ajaxCall(l),r=await JSON.parse(d);if(r.success){e.progressMode.changeText(__(".zip extracted, checking files...","modula-best-grid-gallery"));const a=await e.checkPaths(JSON.stringify(r.data));if(!a.success)return void e.progressMode.changeText(a.data);e.progressMode.changeText(__("Found ","modula-best-grid-gallery")+a.data.length+__(" folders. Starting files validation...","modula-best-grid-gallery"));const t=await e.filesValidation(JSON.stringify(a.data));if(!t.success)return void e.progressMode.changeText(t.data);e.progressMode.changeText(__("Found ","modula-best-grid-gallery")+t.data.length+__(" valid files. Starting importing the files...","modula-best-grid-gallery")),e.importFiles(t.data,!1)}},filesuploaded:function(){}})}initializeUploaders(){new this.zipUploadHandler}updateSendButtonState(e,a){const t=e.querySelectorAll('input[type="checkbox"]:checked');a.classList.toggle("disabled",0===t.length)}}document.addEventListener("DOMContentLoaded",(function(){window.send_to_browse_file_url=function(e){tb_remove(),window.send_to_editor=window.send_to_editor_default},new ModulaGalleryUpload}));