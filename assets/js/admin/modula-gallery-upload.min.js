const{__:__}=wp.i18n;wp.Modula=void 0===wp.Modula?{}:wp.Modula;class ModulaGalleryUpload{postID=0;progressClass=!1;deleteFiles=!0;zipUploadHandler=null;constructor(){const e=this;e.add_actions(),e.postObject=document.getElementById("post_ID"),e.postObject&&(e.postID=e.postObject.value)}add_actions(){const e=this,a=document.getElementById("modula-uploader-folder-browser"),t=document.getElementById("modula_create_gallery");a&&(a.addEventListener("click",(function(a){return a.preventDefault(),window.send_to_editor=window.send_to_browse_file_url,tb_show("<h1>"+modulaGalleryUpload.browseFolder+"</h1>","media-upload.php?post_id="+e.postID+"&amp;type=modula_file_browser&amp;from=wpdlm01&amp;TB_iframe=true&amp;width=800&amp;height=600"),!1})),e.readIframeData(),e.setUploaders(),e.initializeUploaders());const l=document.querySelector(".modula_file_browser");l&&l.addEventListener("change",(function(a){a.target.matches('input[type="checkbox"]')&&e.updateSendButtonState(l,t)}))}fileBrowser(){const e=this;document.body.addEventListener("click",(function(a){a.target&&a.target.matches(".modula_file_browser a")&&(a.preventDefault(),e.addFolderClick(a.target))})),e.foldersFilesValidation()}addFolderClick(e){const a=this,t=jQuery(e),l=t.closest("li"),o=l.find('input[type="checkbox"]').is(":checked");if(l.is(".folder_open"))l.find("ul").remove(),l.removeClass("folder_open");else{t.after('<ul class="load_tree loading"></ul>');var s={action:"modula_list_folders",path:t.attr("data-path"),postID:a.postID,security:modulaGalleryUpload.security,"input-checked":o};jQuery.post(modulaGalleryUpload.ajaxUrl,s,(function(e){l.addClass("folder_open"),e?l.find(".load_tree").html(e):l.find(".load_tree").html(modulaGalleryUpload.noSubFolders),l.find(".load_tree").removeClass("load_tree loading")}))}return!1}foldersFilesValidation(){const e=this;document.getElementById("modula_create_gallery").addEventListener("click",(async function(a){a.preventDefault(),e.deleteFiles=document.getElementById("delete_files").checked,e.progressClass.changeText(modulaGalleryUpload.startFolderValidation);const t=document.querySelectorAll('.modula_file_browser input[type="checkbox"]:checked'),l=Array.from(t).map((e=>e.value)),o=await e.checkPaths(l);if(!o.success)return void e.progressClass.changeText(o.data);e.progressClass.changeText(__("Found ","modula-best-grid-gallery")+o.data.length+__(" folders. Starting files validation...","modula-best-grid-gallery"));const s=await e.filesValidation(o.data);s.success?(e.progressClass.changeText(__("Found ","modula-best-grid-gallery")+s.data.length+__(" valid files. Starting importing the files...","modula-best-grid-gallery")),e.importFiles(s.data)):e.progressClass.changeText(s.data)}))}async checkPaths(e){if(0===e.length)return{success:!1,data:modulaGalleryUpload.noFoldersSelected};const a=this;a.postID||(a.postID=document.getElementById("post_ID").value);const t={action:"modula_check_paths",paths:e,security:modulaGalleryUpload.security,post_ID:a.postID},l=await a.ajaxCall(t);return await JSON.parse(l)}async filesValidation(e){const a={action:"modula_check_files",paths:e,security:modulaGalleryUpload.security},t=await this.ajaxCall(a);return await JSON.parse(t)}async ajaxCall(e){return new Promise(((a,t)=>{var l=new XMLHttpRequest,o=new URLSearchParams;if(e)for(let a in e)e.hasOwnProperty(a)&&o.append(a,e[a]);l.open("POST",modulaGalleryUpload.ajaxUrl,!0),l.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),l.onreadystatechange=function(){4===l.readyState&&(200===l.status?a(l.response):t(l.response))},l.onerror=function(){console.error("Request failed")},l.send(o.toString())}))}async importFiles(e){const a=this;0===a.postID&&(a.postID=document.getElementById("post_ID").value);let t=[];a.progressClass.update(.3,e.length);for(let l=0;l<e.length;l++){a.progressClass.changeText(__("Importing file ","modula-best-grid-gallery")+(l+1)+__(" of ","modula-best-grid-gallery")+e.length);const o={action:"modula_import_file",file:e[l],post_ID:a.postID,security:modulaGalleryUpload.security,delete_files:a.deleteFiles},s=await a.ajaxCall(o),r=await JSON.parse(s);r.success?(a.progressClass.update(l+1,e.length),t.push(r.data)):a.progressClass.changeText(r.data)}t.length>0?(a.progressClass.changeText(__("Imported ","modula-best-grid-gallery")+t.length+__(" files.","modula-best-grid-gallery")),setTimeout((function(){a.progressClass.hideBar(),a.progressClass.changeText(modulaGalleryUpload.updatingGallery),a.updateGallery(t)}),2e3)):a.progressClass.hideBar()}async updateGallery(e){const a=this;a.postID=document.getElementById("post_ID").value;const t={action:"modula_add_images_ids",ids:e,galleryID:a.postID,security:modulaGalleryUpload.security},l=await a.ajaxCall(t),o=await JSON.parse(l);if(o.success){a.progressClass.changeText(modulaGalleryUpload.galleryUpdated);const e={action:"modula_gallery_updated",postID:a.postID,images:o.data,security:modulaGalleryUpload.security};a.sendDataToParent(e)}}sendDataToParent(e){window.parent.postMessage(e,"*")}readIframeData(){const e=this;window.addEventListener("message",(function(a){if(a.data){if(void 0===a.data.action||"undefined"===a.data.security)return;if(modulaGalleryUpload.security!==a.data.security)return;if("modula_gallery_updated"===a.data.action){tb_remove(),e.addFilesToGallery(a.data.images);const t=document.querySelector("#wpbody-content > .wrap"),l=__("Import process completed.","modula-best-grid-gallery");e.addNotice(t,l,"success")}}}))}addFilesToGallery(e){const a=this,t=Object.values(e);for(let e=0;e<t.length;e++){const l=a.generateSingleImage(t[e]);"start"===document.querySelector('input[name="modula-settings[upload_position]"]:checked').value&&(wp.Modula.Items.add(l,{at:0}),wp.Modula.Items.trigger("newItemAdded",l)),wp.Modula.GalleryView.render()}}generateSingleImage(e){var a={halign:"center",valign:"middle",link:"",target:"",togglelightbox:"",hideTitle:""};return void 0!==e.sizes?(a.full=e.sizes.full.url,void 0!==e.sizes.large?a.thumbnail=e.sizes.large.url:a.thumbnail=a.full):(a.full=e.url,a.thumbnail=a.full),a.id=e.id,a.alt=e.alt,a.orientation=e.orientation,a.title=e.title,a.description=e.caption,new wp.Modula.items.model(a)}addNotice(e,a,t){const l=document.createElement("div");l.className="notice notice-"+t+" is-dismissible",l.innerHTML="<p>"+a+"</p>",e.insertBefore(l,e.firstChild)}setUploaders(){const e=this;e.zipUploadHandler=Backbone.Model.extend({uploaderOptions:{container:jQuery("#modula-uploader-container"),browser:jQuery("#modula-upload-zip-browser"),params:{type:"modula-gallery",action:"modula_upload_zip",short:!0}},progressBar:jQuery(".modula-progress-bar"),containerUploader:jQuery(".modula-uploading-info"),errorContainer:jQuery(".modula-error-container"),galleryCotainer:jQuery("#modula-uploader-container .modula-uploader-inline-content"),modula_files_count:0,limitExceeded:!1,initialize:function(){var e,a=this;(e=new wp.Uploader(a.uploaderOptions)).uploader.bind("FilesAdded",jQuery.proxy(a.filesadded,a)),e.uploader.bind("UploadProgress",jQuery.proxy(a.fileuploading,a)),e.uploader.bind("FileUploaded",jQuery.proxy(a.fileupload,a)),e.uploader.bind("UploadComplete",jQuery.proxy(a.filesuploaded,a)),e.uploader.bind("Error",(function(e,t){let l=t.message;if(void 0!==t.response){l=JSON.parse(t.response).message}a.errorContainer.html('<div class="error fade"><p>'+t.file.name+": "+l+"</p></div>"),e.refresh()}))},filesadded:function(e,a){},fileuploading:function(e,a){},fileupload:async function(a,t,l){var o={action:"modula_unzip_file",fileID:l.response,security:modulaGalleryUpload.security};e.progressClass||(e.progressClass=new ModulaProgressBar("modula-uploader-container"),e.progressClass.display());const s=await e.ajaxCall(o),r=await JSON.parse(s);if(r.success){const a=await e.checkPaths(r.data);if(console.log(a),!a.success)return void e.progressClass.changeText(a.data);e.progressClass.changeText(__("Found ","modula-best-grid-gallery")+a.data.length+__(" folders. Starting files validation...","modula-best-grid-gallery"));const t=await e.filesValidation(a.data);if(!t.success)return void e.progressClass.changeText(t.data);e.progressClass.changeText(__("Found ","modula-best-grid-gallery")+t.data.length+__(" valid files. Starting importing the files...","modula-best-grid-gallery")),e.importFiles(t.data)}},filesuploaded:function(){}})}initializeUploaders(){new this.zipUploadHandler}updateSendButtonState(e,a){const t=e.querySelectorAll('input[type="checkbox"]:checked');a.classList.toggle("disabled",0===t.length)}}class ModulaProgressBar{wrapper=null;progressBar=0;progressText="";progress=0;total=0;constructor(e){const a=this;a.wrapper=document.getElementById(e),a.progressBar=document.createElement("div"),a.progressBar.className="modula-progress-bar",a.progressText=document.createElement("div"),a.progressText.className="modula-progress-text"}display(){const e=this;e.wrapper.appendChild(e.progressText),e.wrapper.appendChild(e.progressBar)}update(e,a){const t=this;t.progress=e,t.total=a,t.progressBar.style.width=e/a*100+"%"}changeText(e){this.progressText.innerHTML=e}hideBar(){this.progressBar.style.display="none"}}document.addEventListener("DOMContentLoaded",(function(){window.send_to_browse_file_url=function(e){tb_remove(),window.send_to_editor=window.send_to_editor_default},new ModulaGalleryUpload}));